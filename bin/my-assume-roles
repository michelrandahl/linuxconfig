#!/usr/bin/env bash

if [[ $1 = "dv2" ]]; then
  environment="Dv2"
  account=016407649465
elif [[ $1 = "dv3" ]]; then
  environment="Dv3"
  account=141229858785
elif [[ $1 = "trn" ]]; then
  environment="Trn"
  account=664823476557
elif [[ $1 = "tst" ]]; then
  environment="Tst"
  account=335445898311
elif [[ $1 = "ts2" ]]; then
  environment="Ts2"
  account=168300323433
else
  environment="Dev"
  account=556208514827
fi

echo "environment: ${environment}"

echo "account: ${account}"

OUTPUT=$(awsprocesscreds-saml --no-cache -e 'https://adfs.ccta.dk/adfs/ls/IdpInitiatedSignOn.aspx?loginToRp=urn:amazon:webservices' -u mnie@ufst.dk -p adfs -a arn:aws:iam::$account:role/system/AWS-IAM-User-$environment)

if [[ $? -eq 0 ]]; then
    cat << EOF > $HOME/.aws-credentials
[default]
aws_access_key_id = $(echo $OUTPUT | jq -r '.AccessKeyId')
aws_secret_access_key = $(echo $OUTPUT | jq -r '.SecretAccessKey')
aws_session_token = $(echo $OUTPUT | jq -r '.SessionToken')
EOF

    echo "Your session will expire at " $(echo $OUTPUT | jq '.Expiration')
    echo ""
    echo "In order for the AWS s3 Java SDK to locate the credentials file, set the following envar:"
    echo ""
    echo "     AWS_CREDENTIAL_PROFILES_FILE=$HOME/.aws-credentials"
    echo ""
    echo "Be sure to export the AWS_REGION envar as well:"
    echo ""
    echo "     export AWS_REGION=eu-west-1"
else
    echo ""
    echo "Failed to assume role."
    echo ""
fi
