#!/usr/bin/env bash

# TODO try fetch for current query with a date of 2019-02-25 09:00:00

# name = $1
# ssid = $2
# pw   = $3

END_TIME=$(date +%s)
START_TIME=$(date -d "2019-02-25 09:00:00" +%s) # $(date -d "$1" +%s)
echo $START_TIME
LOG_GROUP_NAME="/eog/aud-iceeog-dev"
# QUERY_STRING="fields @timestamp, @message | sort @timestamp"
QUERY_STRING="
fields @timestamp, @message
| filter Correlation_Id=\"Root=1-5c73ac2b-b6935fbacb2429642b9f49c2;Parent=4f88150d7b1cf1a1;Sampled=1\"
| sort @timestamp
"

QUERY_ID=$(aws logs start-query --log-group-name $LOG_GROUP_NAME --start-time $START_TIME --end-time $END_TIME --query-string "$QUERY_STRING" --limit 25 --profile ice-dev | jq -c .queryId | xargs)
echo "QUERY_ID: $QUERY_ID"

# sleep 5
RESULT=$(aws logs get-query-results --query-id "$QUERY_ID" --profile ice-dev)
while [ $(echo $RESULT | jq -c .status | xargs) == "Running" ]; do
    echo "RUNNING..."
    sleep 1
    RESULT=$(aws logs get-query-results --query-id "$QUERY_ID" --profile ice-dev)
done

echo $RESULT | jq . > cloudwatch-result.json
echo $RESULT | jq .

